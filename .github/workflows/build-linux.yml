name: Build Linux

on:
  workflow_dispatch:
    inputs:
      artifact_prefix:
        description: Prefix for uploaded artifact names
        required: false
        default: build
        type: string
  workflow_call:
    inputs:
      artifact_prefix:
        required: false
        default: build
        type: string

permissions:
  contents: read

jobs:
  build-linux:
    name: Build (linux)
    runs-on: ubuntu-22.04

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Restore build caches
        uses: actions/cache@v4
        with:
          path: |
            .tools
            cache/openjdk-*.tar.gz
            cache/openjdk-*.zip
            cache/openjfx-*_bin-sdk.zip
            cache/javafx-sdk-*
            ~/.ivy2/cache
          key: ${{ runner.os }}-build-cache-${{ hashFiles('build.xml', 'app.properties', 'scripts/bootstrap-dev.sh', 'cache/get-java.sh', 'cache/get-java.ps1', 'cache/get-jfx.sh', 'cache/get-jfx.ps1') }}
          restore-keys: |
            ${{ runner.os }}-build-cache-

      - name: Bootstrap build (Ant/Ivy)
        run: ./scripts/bootstrap-dev.sh --install

      - name: Smoke CLI
        run: ./scripts/smoke.sh

      - name: Download appimagetool
        run: |
          mkdir -p .tools
          curl -L "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -o .tools/appimagetool.AppImage
          chmod +x .tools/appimagetool.AppImage

      - name: Build Linux AppImage
        env:
          APPIMAGETOOL: .tools/appimagetool.AppImage
          APPIMAGE_UPDATE_INFO: gh-releases-zsync|${{ github.repository_owner }}|${{ github.event.repository.name }}|latest|FileBot_*-x86_64.AppImage.zsync
        run: ./scripts/build-appimage.sh

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}-linux
          path: |
            dist/*.AppImage
            dist/*.AppImage.zsync
          if-no-files-found: error

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ inputs.artifact_prefix }}-linux
          path: artifacts/logs
          if-no-files-found: ignore
